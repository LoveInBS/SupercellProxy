using Blake2Fast;
using SupercellProxy.Playground.Crypto.NaCl;
using SupercellProxy.Playground.Network.Messages;
using SupercellProxy.Playground.Network.Streams;
using System.Net;
using System.Net.Sockets;
using System.Text;

namespace SupercellProxy.Playground.Network.Sides;

public class Server(string listenAddress, int listenPort)
{
    // https://github.com/ReversedCell/ScDocumentation/wiki/Encryption-Setup
    // https://github.com/ReversedCell/ScDocumentation/wiki/Protocol

    public async Task RunAsync(CancellationToken cancellationToken = default)
    {
        Test();
        return;
        var listener = new TcpListener(IPAddress.Parse(listenAddress), listenPort);
        listener.Start();
        Console.WriteLine($"[{DateTime.Now:T}] Listening on {listenAddress}:{listenPort}");

        while (!cancellationToken.IsCancellationRequested)
        {
            var client = await listener.AcceptTcpClientAsync(cancellationToken);
            var stream = new SupercellStream(client.GetStream());

            while (client.Connected)
            {
                var _10100 = await stream.ReadMessageAsync(cancellationToken);
                await stream.WriteMessageAsync(CreateServerHelloContainer(), cancellationToken);
                var _10101 = await stream.ReadMessageAsync(cancellationToken);
                Console.WriteLine(_10101);
                Console.WriteLine(Convert.ToHexString(_10101.Payload.ToArray()));
            }
        }
    }

    private static MessageContainer CreateServerHelloContainer()
    {
        var serverHelloStream = SupercellStream.Create();
        serverHelloStream.WriteByteArray(new byte[24]);
        return new MessageContainer(20100, 0, serverHelloStream);
    }

    private static void Test()
    {
        // [21:10:19] Listening on 0.0.0.0:9339
        // MessageContainer { Id = 10101, Version = 3247, Payload = 2B5051BF96AAFD5DE2F6820D2F1B7127F16EE6C8D9A45736E4A25E23C890BF782FAFCB80B38C10AF10CA6C2FD22AEB6C48B7E36387CEF804C3B860279F45C... }
        // prefixed by client public key => 2B5051BF96AAFD5DE2F6820D2F1B7127F16EE6C8D9A45736E4A25E23C890BF78 2FAFCB80B38C10AF10CA6C2FD22AEB6C48B7E36387CEF804C3B860279F45C138D860175C1343F716421689A81BAB8D2ED04887B591AA6E74D577921BFC14FA4FAAF81E8D899AB0B5B35C41FF977BF7E279CD4C11EC06D1C7497DCE57415BA9DBF11E97BBBB73D4825AD9C05ABA7CE27CE3C8E33F9B9A3168BCAA1F79C71E9387D982B2E6B7A68871372A26D0722CDFA1D0DDA08471A56BED1E0F43619FC352C03B92A8BF2BDA95573CDC7D10928B489E27EEF11E8C48A32AFCECFBC80EF3275BFF4CD01DF199374D3CCD985C1452CAC61D7BFC9F38C3233B038675B2B6D1FB78B5533251C79DAE1B7BF8EDF9BFB85F2DBA778D81DB2557EC6C42C977200BF0641B24F2AFDB42BA8687017F1DBBEF8E92659EE91355B72F260AB506C406D63364486D006FA754D56DF0EB5BC2EAB5194E66EEE30F6C7EA85A50347C4E8973945AFF13755B996135E677EAD650491349C68745D6766751F248C0F3C8D6F919D032DDF837D255EB7686A337044B907B405DE19FF9E4805A28BF0603F6B8647E48EE6BC164A197D56C284C7432BA8AE3A911047E9BE03BE6EE61FA222AD4324E183244830E75E22E89805A04EDB69D353B524FB16A4616E579ED92E11DAF94A768952CD0AF19F6757677186D5B38F45C80DFB969CD38780E0108C26FAE8C74034D86C7C3B9D152D2B8540BFEC6F81A45086EDE8F243A81B6DDEC3666A8DB4F8405826273F1B41D042415680E41ED2983A9DEB9A031491FC92C6A1C5C4E5C406A43CE77EAE98CB63D5E01322836462C8A51DD92AFDA225BD3734F6D9B98F177C88EC03BAF503DAD34949990BDAAAF092A1BC389E2AEB15702F76DB75E3218527C425D28646D24E427BEFCA3D890F7ED1B3F9745472362B285E9157BB91420B997112DE93E74705BEF8CA6335AD66B88D59A852FA853D6D149411B588F76A5DF70638BFA52F05404D49CE1664A86F9EB41130AFCDB094691376AF4928E82EEA16CAF843E4F31498A751F5C3C951A21BAF901E7E96734F0587672F3D548B6C2B8B05A0AE588C61F0B633F20B9ED7E870B94A3A9D46FF70FF3F57A2F1E5C259C03B41C0F40F24B7A5FCF4CD63796DF8481D2A4EF8790CFF2B56F75D2C713BADE67115C3ACC0C00DA30

        var sessionToken = new byte[24]; // yes, 24 zeroes
        var serverPrivateKey = new byte[32]; // yes, 32 zeroes, I am ok with this
        var serverPublicKey = TweetNaCl.CryptoScalarmultBase(serverPrivateKey);

        // First encrypted packet by client with our serverPublicKey
        var _10101_payload = Convert.FromHexString("2B5051BF96AAFD5DE2F6820D2F1B7127F16EE6C8D9A45736E4A25E23C890BF782FAFCB80B38C10AF10CA6C2FD22AEB6C48B7E36387CEF804C3B860279F45C138D860175C1343F716421689A81BAB8D2ED04887B591AA6E74D577921BFC14FA4FAAF81E8D899AB0B5B35C41FF977BF7E279CD4C11EC06D1C7497DCE57415BA9DBF11E97BBBB73D4825AD9C05ABA7CE27CE3C8E33F9B9A3168BCAA1F79C71E9387D982B2E6B7A68871372A26D0722CDFA1D0DDA08471A56BED1E0F43619FC352C03B92A8BF2BDA95573CDC7D10928B489E27EEF11E8C48A32AFCECFBC80EF3275BFF4CD01DF199374D3CCD985C1452CAC61D7BFC9F38C3233B038675B2B6D1FB78B5533251C79DAE1B7BF8EDF9BFB85F2DBA778D81DB2557EC6C42C977200BF0641B24F2AFDB42BA8687017F1DBBEF8E92659EE91355B72F260AB506C406D63364486D006FA754D56DF0EB5BC2EAB5194E66EEE30F6C7EA85A50347C4E8973945AFF13755B996135E677EAD650491349C68745D6766751F248C0F3C8D6F919D032DDF837D255EB7686A337044B907B405DE19FF9E4805A28BF0603F6B8647E48EE6BC164A197D56C284C7432BA8AE3A911047E9BE03BE6EE61FA222AD4324E183244830E75E22E89805A04EDB69D353B524FB16A4616E579ED92E11DAF94A768952CD0AF19F6757677186D5B38F45C80DFB969CD38780E0108C26FAE8C74034D86C7C3B9D152D2B8540BFEC6F81A45086EDE8F243A81B6DDEC3666A8DB4F8405826273F1B41D042415680E41ED2983A9DEB9A031491FC92C6A1C5C4E5C406A43CE77EAE98CB63D5E01322836462C8A51DD92AFDA225BD3734F6D9B98F177C88EC03BAF503DAD34949990BDAAAF092A1BC389E2AEB15702F76DB75E3218527C425D28646D24E427BEFCA3D890F7ED1B3F9745472362B285E9157BB91420B997112DE93E74705BEF8CA6335AD66B88D59A852FA853D6D149411B588F76A5DF70638BFA52F05404D49CE1664A86F9EB41130AFCDB094691376AF4928E82EEA16CAF843E4F31498A751F5C3C951A21BAF901E7E96734F0587672F3D548B6C2B8B05A0AE588C61F0B633F20B9ED7E870B94A3A9D46FF70FF3F57A2F1E5C259C03B41C0F40F24B7A5FCF4CD63796DF8481D2A4EF8790CFF2B56F75D2C713BADE67115C3ACC0C00DA30");

        var clientPublicKey = _10101_payload[..32];
        var loginMessageEncrypted = _10101_payload[32..];

        var hasher = Blake2b.CreateIncrementalHasher(digestLength: 24);
        hasher.Update(clientPublicKey);
        hasher.Update(serverPublicKey);
        var tempNonce = hasher.Finish();

        try
        {
            // Console.WriteLine(Encoding.UTF8.GetString(loginMessageEncrypted));
            var decrypted = TweetNaCl.CryptoBoxOpen(loginMessageEncrypted, tempNonce, clientPublicKey, serverPrivateKey);
            // var decrypted = CustomNaCl.OpenPublicBox(loginMessageEncrypted, tempNonce, serverPrivateKey, clientPublicKey);

            var sessionTokenDecrypted = decrypted[..24];
            var clientNonceDecrypted = decrypted[24..48];
            var loginMessageDecrypted = decrypted[48..];

            if (!sessionToken.SequenceEqual(sessionTokenDecrypted))
                throw new Exception($"Decryption error\nEXPECTED: {Convert.ToHexString(sessionToken)}\nRECEIVED: {Convert.ToHexString(sessionTokenDecrypted)}");

            Console.WriteLine("ENCRYPTED:");
            Console.WriteLine(Convert.ToHexString(loginMessageEncrypted));

            Console.WriteLine();
            Console.WriteLine();
            Console.WriteLine();

            Console.WriteLine("DECRYPTED:");
            Console.WriteLine(Convert.ToHexString(decrypted));

            Console.WriteLine();
            Console.WriteLine();
            Console.WriteLine();

            Console.WriteLine("LOGIN MESSAGE:");

            Console.WriteLine(Encoding.UTF8.GetString(loginMessageDecrypted));
        }
        catch (Exception exception)
        {
            Console.WriteLine(exception);
        }
    }
}